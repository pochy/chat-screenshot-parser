<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WeChat ç¿»è¨³ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .header {
        background: #2c3e50;
        color: white;
        padding: 1rem 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .file-input-container {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 0.5rem;
      }

      .file-input-container input[type="file"] {
        flex: 1;
        padding: 0.5rem;
        background: white;
        border-radius: 4px;
        border: none;
      }

      .quick-load {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .quick-load-btn {
        padding: 0.5rem 1rem;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .quick-load-btn:hover {
        background: #2980b9;
      }

      .container {
        display: flex;
        height: calc(100vh - 120px);
      }

      .sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        padding: 1rem;
      }

      .filter-section {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
      }

      .filter-section label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .filter-section input,
      .filter-section select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .stats {
        background: #ecf0f1;
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-size: 0.85rem;
      }

      .stats div {
        margin-bottom: 0.25rem;
      }

      .message-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .message-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
      }

      .message-item:hover {
        background: #e9ecef;
      }

      .message-item.active {
        background: #d4edff;
        border-left-color: #3498db;
      }

      .message-item.has-detailed {
        background: #e8f5e9;
      }

      .message-item.has-detailed.active {
        background: #c8e6c9;
        border-left-color: #4caf50;
      }

      .message-item-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
        font-size: 0.85rem;
      }

      .message-id {
        font-weight: 600;
        color: #555;
      }

      .message-lang {
        padding: 0.1rem 0.4rem;
        background: #3498db;
        color: white;
        border-radius: 3px;
        font-size: 0.75rem;
      }

      .message-lang.zh {
        background: #e74c3c;
      }

      .message-preview {
        font-size: 0.9rem;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
        background: white;
      }

      .content.empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 1.2rem;
      }

      .message-detail {
        max-width: 900px;
        margin: 0 auto;
      }

      .detail-header {
        background: #ecf0f1;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 2rem;
      }

      .detail-header h2 {
        font-size: 1.3rem;
        margin-bottom: 0.5rem;
        color: #2c3e50;
      }

      .detail-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        color: #666;
      }

      .section {
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #3498db;
      }

      .simple-translation {
        background: #e3f2fd;
        padding: 1rem;
        border-radius: 4px;
        font-size: 1rem;
        line-height: 1.6;
      }

      .detailed-translation {
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e0e6ed;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
      }

      .detailed-translation h3 {
        color: #2c3e50;
        font-size: 1.1rem;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #3498db;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .detailed-translation h3:first-child {
        margin-top: 0;
      }

      .correction-box {
        background: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 4px;
      }

      .correction-label {
        font-weight: bold;
        color: #856404;
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.8rem;
        text-transform: uppercase;
      }

      .word-card-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .word-card {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        border: 1px solid #dee2e6;
        transition: transform 0.2s;
      }

      .word-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .word-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .word-main {
        font-size: 1.2rem;
        font-weight: bold;
        color: #e74c3c;
      }

      .hsk-badge {
        font-size: 0.7rem;
        background: #34495e;
        color: white;
        padding: 0.1rem 0.4rem;
        border-radius: 12px;
      }

      .pinyin {
        color: #3498db;
        font-family: serif;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
      }

      .pos {
        font-size: 0.8rem;
        color: #6c757d;
        font-style: italic;
      }

      .meaning {
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      .explanation {
        font-size: 0.85rem;
        color: #495057;
        line-height: 1.4;
      }

      .nuance-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .nuance-item {
        background: #f1f8ff;
        padding: 0.75rem;
        border-radius: 4px;
      }

      .nuance-label {
        display: block;
        font-size: 0.75rem;
        color: #0366d6;
        font-weight: bold;
        margin-bottom: 0.25rem;
      }

      .reply-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .reply-card {
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        overflow: hidden;
      }

      .reply-type {
        background: #6f42c1;
        color: white;
        padding: 0.4rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .reply-content {
        padding: 1rem;
        background: white;
      }

      .reply-text {
        font-size: 1.05rem;
        font-weight: 500;
        color: #24292e;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f6f8fa;
        border-radius: 4px;
      }

      .reply-reason {
        font-size: 0.85rem;
        color: #586069;
      }

      .copy-btn {
        background: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        color: #666;
        cursor: pointer;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        margin-left: 0.5rem;
      }

      .copy-btn:hover {
        background: #eee;
        color: #333;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: 300px;
        }

        .content {
          height: calc(100vh - 420px);
        }
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #999;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 1rem;
        border-radius: 4px;
        margin: 1rem 0;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ“ WeChat ç¿»è¨³ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼</h1>
      <div class="file-input-container">
        <input type="file" id="fileInput" accept=".jsonl" />
        <div class="quick-load">
          <button
            class="quick-load-btn"
            onclick="loadFile('output/test_detailed.jsonl')"
          >
            test_detailed.jsonl
          </button>
          <button
            class="quick-load-btn"
            onclick="loadFile('output/detailed.jsonl')"
          >
            detailed.jsonl
          </button>
          <button
            class="quick-load-btn"
            onclick="loadFile('output/translated.jsonl')"
          >
            translated.jsonl
          </button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="sidebar">
        <div class="filter-section">
          <label for="searchInput">æ¤œç´¢</label>
          <input
            type="text"
            id="searchInput"
            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢..."
          />
        </div>
        <div class="filter-section">
          <label for="langFilter">è¨€èªãƒ•ã‚£ãƒ«ã‚¿</label>
          <select id="langFilter">
            <option value="all">ã™ã¹ã¦</option>
            <option value="zh">ä¸­å›½èªã®ã¿</option>
            <option value="ja">æ—¥æœ¬èªã®ã¿</option>
          </select>
        </div>
        <div class="filter-section">
          <label for="detailedFilter">è©³ç´°ç¿»è¨³ãƒ•ã‚£ãƒ«ã‚¿</label>
          <select id="detailedFilter">
            <option value="all">ã™ã¹ã¦</option>
            <option value="detailed">è©³ç´°ç¿»è¨³ã‚ã‚Š</option>
            <option value="simple">ç°¡æ˜“ç¿»è¨³ã®ã¿</option>
          </select>
        </div>
        <div class="stats" id="stats"></div>
        <div class="message-list" id="messageList"></div>
      </div>
      <div class="content empty" id="content">
        <div>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
    </div>

    <script>
      let messages = [];
      let filteredMessages = [];
      let currentMessageId = null;

      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            readFile(file);
          }
        });

      // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document
        .getElementById("searchInput")
        .addEventListener("input", filterMessages);
      document
        .getElementById("langFilter")
        .addEventListener("change", filterMessages);
      document
        .getElementById("detailedFilter")
        .addEventListener("change", filterMessages);

      // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
      function readFile(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          parseJSONL(content);
        };
        reader.readAsText(file);
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆãƒ‘ã‚¹æŒ‡å®šï¼‰
      async function loadFile(path) {
        try {
          document.getElementById("content").innerHTML =
            '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
          const response = await fetch(path);
          if (!response.ok) {
            throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${path}`);
          }
          const content = await response.text();
          parseJSONL(content);
        } catch (error) {
          document.getElementById(
            "content"
          ).innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        }
      }

      // JSONL ãƒ‘ãƒ¼ã‚¹
      function parseJSONL(content) {
        try {
          messages = content
            .trim()
            .split("\n")
            .filter((line) => line.trim())
            .map((line) => JSON.parse(line));

          filterMessages();
          updateStats();

          if (messages.length > 0) {
            showMessage(messages[0].id);
          }
        } catch (error) {
          document.getElementById(
            "content"
          ).innerHTML = `<div class="error">JSONLãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        }
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      function filterMessages() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const langFilter = document.getElementById("langFilter").value;
        const detailedFilter = document.getElementById("detailedFilter").value;

        filteredMessages = messages.filter((msg) => {
          // è¨€èªãƒ•ã‚£ãƒ«ã‚¿
          if (langFilter !== "all" && msg.lang !== langFilter) return false;

          // è©³ç´°ç¿»è¨³ãƒ•ã‚£ãƒ«ã‚¿
          if (detailedFilter === "detailed" && !msg.text_ja_detailed)
            return false;
          if (detailedFilter === "simple" && msg.text_ja_detailed) return false;

          // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
          if (searchTerm) {
            let detailedText = '';
            if (msg.text_ja_detailed) {
                try {
                    const data = typeof msg.text_ja_detailed === 'object' ? 
                        msg.text_ja_detailed : JSON.parse(msg.text_ja_detailed);
                    
                    detailedText = [
                        data.natural_translation || '',
                        data.corrected_text || '',
                        (data.word_analysis || []).map(w => `${w.word} ${w.pinyin} ${w.meaning}`).join(' '),
                        (data.nuance_analysis ? Object.values(data.nuance_analysis).join(' ') : ''),
                        (data.reply_suggestions || []).map(s => s.reply).join(' ')
                    ].join(' ');
                } catch (e) {
                    detailedText = msg.text_ja_detailed;
                }
            }

            const searchableText = [
                msg.text || '',
                msg.text_ja || '',
                msg.id || '',
                detailedText
            ].join(' ').toLowerCase();

            if (!searchableText.includes(searchTerm)) return false;
          }

          return true;
        });

        renderMessageList();
        updateStats();
      }

      // çµ±è¨ˆæƒ…å ±æ›´æ–°
      function updateStats() {
        const zhCount = messages.filter((m) => m.lang === "zh").length;
        const jaCount = messages.filter((m) => m.lang === "ja").length;
        const detailedCount = messages.filter((m) => m.text_ja_detailed).length;

        document.getElementById("stats").innerHTML = `
                <div><strong>ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:</strong> ${messages.length}ä»¶</div>
                <div><strong>è¡¨ç¤ºä¸­:</strong> ${filteredMessages.length}ä»¶</div>
                <div><strong>ä¸­å›½èª:</strong> ${zhCount}ä»¶ / <strong>æ—¥æœ¬èª:</strong> ${jaCount}ä»¶</div>
                <div><strong>è©³ç´°ç¿»è¨³:</strong> ${detailedCount}ä»¶</div>
            `;
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆè¡¨ç¤º
      function renderMessageList() {
        const listEl = document.getElementById("messageList");

        if (filteredMessages.length === 0) {
          listEl.innerHTML =
            '<div class="no-detailed">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        listEl.innerHTML = filteredMessages
          .map((msg) => {
            const hasDetailed = msg.text_ja_detailed ? "has-detailed" : "";
            const isActive = msg.id === currentMessageId ? "active" : "";
            const preview = msg.text
              ? msg.text.substring(0, 30)
              : "ãƒ†ã‚­ã‚¹ãƒˆãªã—";

            return `
                    <div class="message-item ${hasDetailed} ${isActive}" onclick="showMessage('${msg.id}')">
                        <div class="message-item-header">
                            <span class="message-id">${msg.id}</span>
                            <span class="message-lang ${msg.lang}">${msg.lang}</span>
                        </div>
                        <div class="message-preview">${preview}</div>
                    </div>
                `;
          })
          .join("");
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è©³ç´°è¡¨ç¤º
      function showMessage(messageId) {
        currentMessageId = messageId;
        const msg = messages.find((m) => m.id === messageId);

        if (!msg) return;

        renderMessageList(); // activeçŠ¶æ…‹ã‚’æ›´æ–°

        const contentEl = document.getElementById("content");
        contentEl.className = "content";

        let html = `
                <div class="message-detail">
                    <div class="detail-header">
                        <h2>${msg.id}</h2>
                        <div class="detail-meta">
                            <span><strong>è¨€èª:</strong> ${msg.lang}</span>
                            <span><strong>è©±è€…:</strong> ${
                              msg.speaker || "N/A"
                            }</span>
                            ${
                              msg.timestamp
                                ? `<span><strong>æ—¥æ™‚:</strong> ${msg.timestamp}</span>`
                                : ""
                            }
                            ${
                              msg.confidence
                                ? `<span><strong>ä¿¡é ¼åº¦:</strong> ${(
                                    msg.confidence * 100
                                  ).toFixed(1)}%</span>`
                                : ""
                            }
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">åŸæ–‡</div>
                        <div class="simple-translation">${escapeHtml(
                          msg.text || "ãƒ†ã‚­ã‚¹ãƒˆãªã—"
                        )}</div>
                    </div>
            `;

        if (msg.text_ja) {
          html += `
                    <div class="section">
                        <div class="section-title">ç°¡æ˜“ç¿»è¨³</div>
                        <div class="simple-translation">${escapeHtml(
                          msg.text_ja
                        )}</div>
                    </div>
                `;
        }

        if (msg.text_ja_detailed) {
          html += `
                    <div class="section">
                        <div class="section-title">è©³ç´°è§£èª¬ï¼ˆå­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ï¼‰</div>
                        <div class="detailed-translation" id="detailedContent">
                            ${renderDetailedJSON(msg.text_ja_detailed)}
                        </div>
                    </div>
                `;
        } else {
          html += `
                    <div class="section">
                        <div class="section-title">è©³ç´°è§£èª¬</div>
                        <div class="no-detailed">è©³ç´°è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                    </div>
                `;
        }

        html += "</div>";
        contentEl.innerHTML = html;
      }

      // è©³ç´°JSONã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      function renderDetailedJSON(dataStr) {
        try {
          // ã¾ãšJSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
          const data =
            typeof dataStr === "object" ? dataStr : JSON.parse(dataStr);

          let html = "";

          // èª¤å­—ä¿®æ­£
          if (data.corrected_text) {
            html += `
                        <div class="correction-box">
                            <span class="correction-label">âš ï¸ èª¤å­—ä¿®æ­£</span>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">
                                <del style="color: #d73a49;">${escapeHtml(
                                  data.original_text
                                )}</del>
                                <span style="margin: 0 0.5rem;">â†’</span>
                                <strong style="color: #28a745;">${escapeHtml(
                                  data.corrected_text
                                )}</strong>
                            </div>
                            <div class="correction-reason" style="font-size: 0.9rem; color: #586069;">
                                ${escapeHtml(data.typo_note)}
                            </div>
                        </div>
                    `;
          }

          // è‡ªç„¶ãªæ—¥æœ¬èªè¨³
          html += `
                    <h3>ğŸ¯ è‡ªç„¶ãªæ—¥æœ¬èªè¨³</h3>
                    <div class="simple-translation" style="margin-bottom: 1.5rem; background: #f1f8ff; border-left: 4px solid #0366d6;">
                        ${escapeHtml(data.natural_translation)}
                    </div>
                `;

          // å˜èªè§£èª¬
          if (data.word_analysis && data.word_analysis.length > 0) {
            html += `<h3>ğŸ“š å˜èªãƒ»æ…£ç”¨å¥ã®è§£èª¬</h3>`;
            html += `<div class="word-card-container">`;
            data.word_analysis.forEach((word) => {
              html += `
                            <div class="word-card">
                                <div class="word-header">
                                    <span class="word-main">${escapeHtml(
                                      word.word
                                    )}</span>
                                    ${
                                      word.hsk_level
                                        ? `<span class="hsk-badge">HSK ${word.hsk_level}</span>`
                                        : ""
                                    }
                                </div>
                                <div class="pinyin">${escapeHtml(
                                  word.pinyin
                                )}</div>
                                <div class="pos">${escapeHtml(
                                  word.part_of_speech
                                )}</div>
                                <div class="meaning">${escapeHtml(
                                  word.meaning
                                )}</div>
                                <div class="explanation">${escapeHtml(
                                  word.explanation
                                )}</div>
                            </div>
                        `;
            });
            html += `</div>`;
          }

          // ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹åˆ†æ
          if (data.nuance_analysis) {
            html += `<h3>åˆ†æ ğŸ§  ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã¨èƒŒæ™¯</h3>`;
            html += `
                        <div class="nuance-grid">
                            <div class="nuance-item">
                                <span class="nuance-label">æ„Ÿæƒ…ãƒˆãƒ¼ãƒ³</span>
                                <div>${escapeHtml(
                                  data.nuance_analysis.emotional_tone
                                )}</div>
                            </div>
                            <div class="nuance-item">
                                <span class="nuance-label">é–¢ä¿‚æ€§</span>
                                <div>${escapeHtml(
                                  data.nuance_analysis.relationship
                                )}</div>
                            </div>
                            <div class="nuance-item">
                                <span class="nuance-label">æ–‡åŒ–çš„èƒŒæ™¯</span>
                                <div>${escapeHtml(
                                  data.nuance_analysis.cultural_background
                                )}</div>
                            </div>
                            <div class="nuance-item">
                                <span class="nuance-label">æ„å›³ãƒ»æœŸå¾…</span>
                                <div>${escapeHtml(
                                  data.nuance_analysis.intention
                                )}</div>
                            </div>
                        </div>
                        <div class="nuance-item" style="margin-top: 0.5rem;">
                            <span class="nuance-label">è¦ç´„</span>
                            <div>${escapeHtml(
                              data.nuance_analysis.summary
                            )}</div>
                        </div>
                    `;
          }

          // è¿”ä¿¡æ¡ˆ
          if (data.reply_suggestions && data.reply_suggestions.length > 0) {
            html += `<h3>ğŸ’¬ è¿”ä¿¡ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³</h3>`;
            html += `<div class="reply-container">`;
            data.reply_suggestions.forEach((suggestion) => {
              html += `
                            <div class="reply-card">
                                <div class="reply-type">${escapeHtml(
                                  suggestion.type
                                )}</div>
                                <div class="reply-content">
                                    <div class="reply-text">
                                        ${escapeHtml(suggestion.reply)}
                                        <button class="copy-btn" onclick="copyText('${suggestion.reply.replace(
                                          /'/g,
                                          "\\'"
                                        )}')">ã‚³ãƒ”ãƒ¼</button>
                                    </div>
                                    <div class="reply-reason">${escapeHtml(
                                      suggestion.reason
                                    )}</div>
                                </div>
                            </div>
                        `;
            });
            html += `</div>`;
          }

          return html;
        } catch (e) {
          console.error("JSON parse error, falling back to markdown:", e);
          // JSONã§ãªã„å ´åˆã¯ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã¨ã—ã¦å‡¦ç†
          return marked.parse(dataStr);
        }
      }

      // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼
      function copyText(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
          })
          .catch((err) => {
            console.error("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
          });
      }

      // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
      document.addEventListener("keydown", function (e) {
        if (filteredMessages.length === 0) return;

        const currentIndex = filteredMessages.findIndex(
          (m) => m.id === currentMessageId
        );

        if (e.key === "ArrowDown" || e.key === "j") {
          e.preventDefault();
          if (currentIndex < filteredMessages.length - 1) {
            showMessage(filteredMessages[currentIndex + 1].id);
          }
        } else if (e.key === "ArrowUp" || e.key === "k") {
          e.preventDefault();
          if (currentIndex > 0) {
            showMessage(filteredMessages[currentIndex - 1].id);
          }
        }
      });
    </script>
  </body>
</html>
